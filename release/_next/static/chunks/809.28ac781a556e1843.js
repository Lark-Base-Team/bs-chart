(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[809],{9809:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return Home}});var l=i(4810),r=i(3124),a=i(4576),n=i(4484),o=i.n(n),s=i(8466),c=i(3260);let Emitter=class Emitter{emitSync(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];this.events.forEach(e=>{e(...t)})}emitLifeCycle(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.lastEmitArgs=t,Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}emit(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}on(e){return this.lastEmitArgs&&e(...this.lastEmitArgs),this.events.add(e),()=>{this.off(e)}}wait(){return new Promise(e=>{let t=this.on(function(){for(var i=arguments.length,l=Array(i),r=0;r<i;r++)l[r]=arguments[r];e(l),t()})})}off(e){this.events.delete(e)}destroy(){this.events.clear()}constructor(){this.events=new Set}};let BsSdk=class BsSdk{async getRecordIds(e){return e||(e=await this.getActiveTable()),await e.getRecordIdList()}async getRecordById(e,t){return await e.getRecordById(t)}async getActiveTable(){return this.activeTable||(this.activeTable=await c.ws.base.getActiveTable()),this.activeTable}async getTableList(){return await c.ws.base.getTableList()}async getFieldList(e){let t=await e.getFieldList();for(let e=0;e<t.length;e++){let i=t[e];i.name=await i.getName()}return t}async getSelection(){return await c.ws.base.getSelection()}async getSelectionQuery(e){let t=e.tableId?await this.base.getTableById(e.tableId):void 0,i={table:t,view:e.viewId?await (null==t?void 0:t.getViewById(e.viewId)):void 0,field:e.fieldId?await (null==t?void 0:t.getFieldById(e.fieldId)):void 0,record:e.recordId?await (null==t?void 0:t.getRecordById(e.recordId)):void 0};return i}async getSelection2(){let{viewId:e=!1,fieldId:t=!1,recordId:i=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=await this.getSelection();return await this.getSelectionQuery({viewId:e?l.viewId:void 0,fieldId:t?l.fieldId:void 0,recordId:i?l.recordId:void 0})}constructor({onSelectionChange:e=!1,immediatelySelectionChange:t=!0}={}){this.bitable=c.ws,this.base=c.ws.base,this.selectionChangeEmitter=new Emitter,e&&this.base.onSelectionChange(async e=>{this.activeTable=void 0,this.selectionChangeEmitter.emitLifeCycle(e)}),t&&e&&this.getSelection().then(e=>{this.selectionChangeEmitter.emitSync({data:e})})}};let d=(0,a.createContext)({orm:void 0});function BProvide(e){let[t,i]=(0,a.useState)({orm:e.orm}),[n,o]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{let t=e.orm.initEmitter.on(()=>{console.log("init",e.orm),o(!0)});return t},[]),(0,l.jsx)(d.Provider,{value:t,children:(0,l.jsx)(r.l0,{...e.formProps,children:n?e.children:(0,l.jsxs)("div",{style:{height:"500px",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:[(0,l.jsx)(r.yC,{size:"large"}),(0,l.jsx)("div",{style:{fontSize:"14px",color:"#333",marginTop:"5px"},children:e.loadingText||"loading..."})]})})})}let BsORM=class BsORM{getRecord(e){return this.sdk.getRecordById(this.active.table,e).then(e=>e.fields)}get active(){return this.models.get(this.activeModel)}async use(e){if(await this.initEmitter.wait(),"string"==typeof e){this.activeModel=e;let t=this.models.get(e);if(!t)return;return t.table}return this.activeModel=e.id,e}getFields(){let e=this.activeModel;if(!e)throw Error("table not found");let t=this.models.get(e);if(!t)throw Error("table not found");return t.fields}getFieldsMap(){let e=this.getFields(),t=new Map;return e.forEach(e=>{t.set(e.id,e)}),t}constructor(e){this.sdk=e,this.models=new Map,this.initEmitter=new Emitter,e.getTableList().then(async t=>{await Promise.all(t.map(async t=>{let i=await e.getFieldList(t);this.models.set(t.id,{table:t,fields:i})}));let i=await e.getActiveTable();this.activeModel=null==i?void 0:i.id,this.initEmitter.emitLifeCycle()}),e.selectionChangeEmitter.on(async e=>{this.activeModel=e.data.tableId})}};function BSelectField(e){var t,i;let n=(0,a.useContext)(d),o=null===(t=n.orm)||void 0===t?void 0:t.getFields().filter(null!==(i=e.filterOption)&&void 0!==i?i:e=>!0).map(e=>(0,l.jsx)(r.l0.Select.Option,{value:e.id,children:e.name},e.id));return(0,l.jsx)(r.l0.Select,{...e,children:o})}var u=i(269),h=i(4300);function ECharts(e){let{option:t}=e,i=(0,a.useRef)(null);return(0,a.useEffect)(()=>{let l=h.S1(i.current);return console.log(l),l.setOption(t),e.refInstance&&(e.refInstance.current=l),()=>{l.dispose()}},[t,e.refInstance]),(0,l.jsx)("div",{ref:i,style:{width:"100%",height:"100%"}})}async function fileToIOpenAttachment(e,t){let i=await e.batchUploadFile([t]);return{name:t.name,size:t.size,type:t.type,token:i[0],timeStamp:t.lastModified}}function base64ToFile(e,t,i){let l=e.split(",");l[0].match(/:(.*?);/)[1];let r=atob(l[1]),a=r.length,n=new Uint8Array(a);for(;a--;)n[a]=r.charCodeAt(a);return new File([n],t,{type:i})}let f=new Map,initState=(e,t)=>{if(f.has(e))return f.get(e);let i=localStorage.getItem(e),l=i?JSON.parse(i):t;return f.set(e,l),l};function useKeepState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default",i="keep-state-".concat(t),[l,r]=(0,a.useState)(initState(i,e));return(0,a.useEffect)(()=>{localStorage.setItem(i,JSON.stringify(l))},[l,i]),[l,r]}let g=new BsSdk({onSelectionChange:!0,immediatelySelectionChange:!0}),p=new BsORM(g);function Home(){var e;let[t,i]=(0,s.$G)(),[n,d]=(0,a.useState)(createOption("line",{A:10,B:10,C:10},{max:10,min:0,order:"default"})),h=(0,a.useRef)(),[f,m]=useKeepState({output:{type:"preview"},chartType:"line",chart:{max:10,min:0,order:"default"}}),v=(0,a.useCallback)(e=>{m(Object.assign({},mergeDeep(f,e)))},[f,m]);(0,a.useEffect)(()=>{console.log("useEffect"),g.bitable.bridge.getLanguage().then(e=>{i.changeLanguage(e.includes("zh")?"zh":"en")})},[]);let y=(0,a.useCallback)(async e=>{if(console.log(e,h),f.select=e.select,0===Object.keys((null==(e=mergeDeep(f,e))?void 0:e.select)||{}).length)return r.FN.error(t("toast-select-number-field"));let i=r.FN.info({icon:(0,l.jsx)(r.yC,{}),content:"".concat(t("toast-gening"),"..."),duration:0}),a="";if("multiToField"!==e.output.type){let t=await g.getSelection();if(console.log({select:t}),t.recordId)a=t.recordId;else{var n;(null==e?void 0:null===(n=e.output)||void 0===n?void 0:n.type)==="preview"&&(a=await (await g.getActiveTable()).getRecords({pageSize:1}).then(e=>e.records[0].recordId))}}if(console.log({recordId:a}),"multiToField"===e.output.type){let a=await g.getRecordIds();if(!a.length)return r.FN.error(t("toast-add-record"));for(let n=0;n<a.length;n++){r.FN.close(i),i=r.FN.info({icon:(0,l.jsx)(r.yC,{}),content:"".concat(t("toast-gening"),"(").concat(n+1,"/").concat(a.length,")..."),duration:0});let o=a[n],s=await gene(o);if(!s)continue;let d=p.getFieldsMap().get(e.output.field);if(await (null==d?void 0:d.getType())!==c.fS.Attachment)return r.FN.close(i),r.FN.error(t("toast-select-field"));null==d||d.setValue(o,[await fileToIOpenAttachment(g.base,base64ToFile(s,Date.now()+".png","image/png"))])}}else if("toField"===e.output.type){if(!a)return r.FN.close(i),r.FN.error(t("toast-select-record"));let l=await gene(a),n=p.getFieldsMap().get(e.output.field);if(await (null==n?void 0:n.getType())!==c.fS.Attachment)return r.FN.close(i),r.FN.error(t("toast-select-field"));null==n||n.setValue(a,[await fileToIOpenAttachment(g.base,base64ToFile(l,Date.now()+".png","image/png"))])}else{if(!a)return r.FN.close(i),r.FN.error(t("toast-select-record"));await gene(a)}async function gene(t){var i;let l=await p.getRecord(t),r=e.select.reduce((e,t)=>{let i=toDisplay(l[t]);if(i||(i=0),"number"==typeof(i=Number(i))&&i==i){var r,a;e[null===(a=p.getFieldsMap())||void 0===a?void 0:null===(r=a.get(t))||void 0===r?void 0:r.name]=i}return e},{});if(0===Object.keys(r).length)return;d(createOption(e.chartType,r,null==e?void 0:e.chart)),console.log(l,r),await new Promise(e=>setTimeout(e,1));let a=null===(i=h.current)||void 0===i?void 0:i.getDataURL();return a}r.FN.close(i),r.FN.success(t("toast-gene-success"))},[f,t]),b=(0,a.useCallback)(e=>{v(e.values)},[v]);function createOption(e,t,i){let l=Object.keys(t),r=Math.max(...l.map(e=>e.length));return("asc"===i.order||"desc"===i.order)&&(l=extractAndSortNumbers(l),"desc"===i.order&&(l=l.reverse())),({get line(){var a;return{wrapStyle:{width:"".concat((null!==(a=l.length)&&void 0!==a?a:0)*100+100,"px"),height:"500px"},animation:!1,xAxis:{type:"category",data:l},yAxis:{type:"value"},series:[{data:l.map(e=>t[e]),type:"line"}]}},get bar(){var n;return{wrapStyle:{width:"".concat((null!==(n=l.length)&&void 0!==n?n:0)*100+100,"px"),height:"500px"},animation:!1,xAxis:{type:"category",data:l},yAxis:{type:"value"},series:[{data:l.map(e=>t[e]),type:"bar"}]}},get radar(){return{wrapStyle:{width:"500px",height:"500px"},animation:!1,textStyle:{fontSize:16},radar:{indicator:l.map(e=>({name:e,max:i.max,min:i.min})),axisName:{color:"#5470c6"},center:["50%","50%"],radius:r>5?"50%":r>4?"60%":"70%"},series:[{name:"Budget vs spending",type:"radar",data:[{value:l.map(e=>t[e]),areaStyle:{color:"rgba(66, 139, 212, 0.3)"},label:{show:!0,position:"inside"}}]}]}}})[e]||{}}return(0,l.jsx)("main",{className:o().main,children:(0,l.jsxs)(BProvide,{orm:p,formProps:{onSubmit:y,onChange:b,labelPosition:"left",initValues:f},loadingText:t("init"),children:[(0,l.jsx)(u.Z,{text:t("field-conf"),style:{marginTop:"10px"},children:(0,l.jsx)(BSelectField,{field:"select",label:t("select-field"),placeholder:t("select-field-tip"),multiple:!0})}),(0,l.jsxs)(u.Z,{text:t("chart-conf"),style:{marginTop:"10px"},children:[(0,l.jsx)(r.l0.Select,{field:"chartType",label:t("chart-conf-type"),optionList:[{label:t("chart-conf-line"),value:"line"},{label:t("chart-conf-bar"),value:"bar"},{label:t("chart-conf-radar"),value:"radar"}],onChange:e=>{console.log(e),v({chartType:e})}}),{get bar(){return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(r.l0.Select,{field:"chart.order",label:t("chart-conf-order"),placeholder:t("chart-conf-"+f.chart.order),optionList:[{label:t("chart-conf-default"),value:"default"},{label:t("chart-conf-asc"),value:"asc"},{label:t("chart-conf-desc"),value:"desc"}]})})},get line(){return(0,l.jsx)(l.Fragment,{children:(0,l.jsx)(r.l0.Select,{field:"chart.order",label:t("chart-conf-order"),placeholder:t("chart-conf-"+f.chart.order),optionList:[{label:t("chart-conf-default"),value:"default"},{label:t("chart-conf-asc"),value:"asc"},{label:t("chart-conf-desc"),value:"desc"}]})})},get radar(){return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(r.l0.InputNumber,{field:"chart.max",placeholder:f.chart.max,label:t("chart-conf-max")}),(0,l.jsx)(r.l0.InputNumber,{field:"chart.min",placeholder:f.chart.min,label:t("chart-conf-min")})]})}}[f.chartType]||null]}),(0,l.jsxs)(u.Z,{text:t("output-conf"),style:{marginTop:"10px"},children:[(0,l.jsxs)(r.l0.Select,{field:"output.type",label:t("output-type"),children:[(0,l.jsx)(r.l0.Select.Option,{value:"preview",children:t("priview")}),(0,l.jsx)(r.l0.Select.Option,{value:"toField",children:t("gene-to-field")}),(0,l.jsx)(r.l0.Select.Option,{value:"multiToField",children:t("gene-multi-to-field")})]}),(null==f?void 0:f.output)&&(null==f?void 0:null===(e=f.output)||void 0===e?void 0:e.type)!=="preview"&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(BSelectField,{field:"output.field",filterOption:e=>(null==e?void 0:e.type)===c.fS.Attachment,label:t("output-field"),placeholder:t("output-field-tip")}),(0,l.jsx)(r.jL,{type:"danger",description:t("output-field-danger"),style:{marginBottom:"10px"}})]})]}),(0,l.jsxs)(r.T,{children:[(0,l.jsx)(r.zx,{htmlType:"submit",block:!0,type:"primary",children:t("btn-gene")}),(0,l.jsx)(r.zx,{type:"secondary",block:!0,onClick:()=>open("https://zhuanlan.zhihu.com/p/669107200"),children:t("btn-help")})]}),(0,l.jsx)("div",{style:{width:"100%",overflow:"scroll"},children:(0,l.jsx)("div",{style:n.wrapStyle,children:(0,l.jsx)(ECharts,{refInstance:h,option:n})})})]})})}function toDisplay(e){var t,i;return"object"==typeof e?null!==(i=null==e?void 0:e.text)&&void 0!==i?i:null==e?void 0:null===(t=e.map)||void 0===t?void 0:t.call(e,e=>{var t;return null!==(t=null==e?void 0:e.text)&&void 0!==t?t:null==e?void 0:e.name}).filter(e=>e).join(","):e}function extractAndSortNumbers(e){let t={零:0,一:1,二:2,三:3,四:4,五:5,六:6,七:7,八:8,九:9,十:10,百:100,千:1e3,万:1e4,亿:1e8};function chineseToNumber(e){let i=0,l=0,r=1;for(let a of e.split("")){let e=t[a];e<10?l=e:(0===l&&(l=1),e>r?(i+=l,i*=e,l=0):i+=l*e,r=e,l=0)}return i+l}function extractNumber(e){let t=e.match(/(\d+|[零一二三四五六七八九十百千万亿]+)/g);return t?t.reduce((e,t)=>e+(isNaN(Number(t))?chineseToNumber(t):Number(t)),0):0}function sortWithNumbers(e,t){let i=extractNumber(e),l=extractNumber(t);return i-l}return e.slice().sort(sortWithNumbers)}function mergeDeep(e,t){let i=Object.keys(t),l=i.length;for(let r=0;r<l;r++){let l=i[r];"object"==typeof t[l]&&"object"==typeof e[l]?mergeDeep(e[l],t[l]):e[l]=t[l]}return e}},4484:function(e){e.exports={main:"Home_main__ElU3j",h4:"Home_h4__4GCIr",code:"Home_code__ESbU9"}}}]);
//# sourceMappingURL=809.28ac781a556e1843.js.map
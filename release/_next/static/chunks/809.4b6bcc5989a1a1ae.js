(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[809],{9809:function(e,t,l){"use strict";l.r(t),l.d(t,{default:function(){return Home}});var i=l(4810),a=l(3124),r=l(4576),n=l(4484),o=l.n(n),s=l(8466),c=l(3260);let Emitter=class Emitter{emitSync(){for(var e=arguments.length,t=Array(e),l=0;l<e;l++)t[l]=arguments[l];this.events.forEach(e=>{e(...t)})}emitLifeCycle(){for(var e=arguments.length,t=Array(e),l=0;l<e;l++)t[l]=arguments[l];return this.lastEmitArgs=t,Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}emit(){for(var e=arguments.length,t=Array(e),l=0;l<e;l++)t[l]=arguments[l];return Promise.resolve().then(()=>{try{this.emitSync(...t)}catch(e){return Promise.reject(e)}})}on(e){return this.lastEmitArgs&&e(...this.lastEmitArgs),this.events.add(e),()=>{this.off(e)}}wait(){return new Promise(e=>{let t=this.on(function(){for(var l=arguments.length,i=Array(l),a=0;a<l;a++)i[a]=arguments[a];e(i),t()})})}off(e){this.events.delete(e)}destroy(){this.events.clear()}constructor(){this.events=new Set}};let BsSdk=class BsSdk{async getRecordIds(e){return e||(e=await this.getActiveTable()),await e.getRecordIdList()}async getRecordById(e,t){return await e.getRecordById(t)}async getActiveTable(){return this.activeTable||(this.activeTable=await c.ws.base.getActiveTable()),this.activeTable}async getTableList(){return await c.ws.base.getTableList()}async getFieldList(e){let t=await e.getFieldList();for(let e=0;e<t.length;e++){let l=t[e];l.name=await l.getName()}return t}async getSelection(){return await c.ws.base.getSelection()}async getSelectionQuery(e){let t=e.tableId?await this.base.getTableById(e.tableId):void 0,l={table:t,view:e.viewId?await (null==t?void 0:t.getViewById(e.viewId)):void 0,field:e.fieldId?await (null==t?void 0:t.getFieldById(e.fieldId)):void 0,record:e.recordId?await (null==t?void 0:t.getRecordById(e.recordId)):void 0};return l}async getSelection2(){let{viewId:e=!1,fieldId:t=!1,recordId:l=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=await this.getSelection();return await this.getSelectionQuery({viewId:e?i.viewId:void 0,fieldId:t?i.fieldId:void 0,recordId:l?i.recordId:void 0})}constructor({onSelectionChange:e=!1,immediatelySelectionChange:t=!0}={}){this.bitable=c.ws,this.base=c.ws.base,this.selectionChangeEmitter=new Emitter,e&&this.base.onSelectionChange(async e=>{this.activeTable=void 0,this.selectionChangeEmitter.emitLifeCycle(e)}),t&&e&&this.getSelection().then(e=>{this.selectionChangeEmitter.emitSync({data:e})})}};let d=(0,r.createContext)({orm:void 0});function BProvide(e){let[t,l]=(0,r.useState)({orm:e.orm}),[n,o]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{let t=e.orm.initEmitter.on(()=>{console.log("init",e.orm),o(!0)});return t},[]),(0,i.jsx)(d.Provider,{value:t,children:(0,i.jsx)(a.l0,{...e.formProps,children:n?e.children:(0,i.jsxs)("div",{style:{height:"500px",display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:[(0,i.jsx)(a.yC,{size:"large"}),(0,i.jsx)("div",{style:{fontSize:"14px",color:"#333",marginTop:"5px"},children:e.loadingText||"loading..."})]})})})}let BsORM=class BsORM{getRecord(e){return this.sdk.getRecordById(this.active.table,e).then(e=>e.fields)}get active(){return this.models.get(this.activeModel)}async use(e){if(await this.initEmitter.wait(),"string"==typeof e){this.activeModel=e;let t=this.models.get(e);if(!t)return;return t.table}return this.activeModel=e.id,e}getFields(){let e=this.activeModel;if(!e)throw Error("table not found");let t=this.models.get(e);if(!t)throw Error("table not found");return t.fields}getFieldsMap(){let e=this.getFields(),t=new Map;return e.forEach(e=>{t.set(e.id,e)}),t}constructor(e){this.sdk=e,this.models=new Map,this.initEmitter=new Emitter,e.getTableList().then(async t=>{await Promise.all(t.map(async t=>{let l=await e.getFieldList(t);this.models.set(t.id,{table:t,fields:l})}));let l=await e.getActiveTable();this.activeModel=null==l?void 0:l.id,this.initEmitter.emitLifeCycle()}),e.selectionChangeEmitter.on(async e=>{this.activeModel=e.data.tableId})}};function BSelectField(e){var t,l;let n=(0,r.useContext)(d),o=null===(t=n.orm)||void 0===t?void 0:t.getFields().filter(null!==(l=e.filterOption)&&void 0!==l?l:e=>!0).map(e=>(0,i.jsx)(a.l0.Select.Option,{value:e.id,children:e.name},e.id));return(0,i.jsx)(a.l0.Select,{...e,children:o})}var u=l(269),h=l(4300);function ECharts(e){let{option:t}=e,l=(0,r.useRef)(null);return(0,r.useEffect)(()=>{let i=h.S1(l.current);return console.log(i),i.setOption(t),e.refInstance&&(e.refInstance.current=i),()=>{i.dispose()}},[t,e.refInstance]),(0,i.jsx)("div",{ref:l,style:{width:"100%",height:"100%"}})}async function fileToIOpenAttachment(e,t){let l=await e.batchUploadFile([t]);return{name:t.name,size:t.size,type:t.type,token:l[0],timeStamp:t.lastModified}}function base64ToFile(e,t,l){let i=e.split(",");i[0].match(/:(.*?);/)[1];let a=atob(i[1]),r=a.length,n=new Uint8Array(r);for(;r--;)n[r]=a.charCodeAt(r);return new File([n],t,{type:l})}let f=new Map,initState=(e,t)=>{if(f.has(e))return f.get(e);let l=localStorage.getItem(e),i=l?JSON.parse(l):t;return f.set(e,i),i};function useKeepState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default",l="keep-state-".concat(t),[i,a]=(0,r.useState)(initState(l,e));return(0,r.useEffect)(()=>{localStorage.setItem(l,JSON.stringify(i))},[i,l]),[i,a]}let g=new BsSdk({onSelectionChange:!0,immediatelySelectionChange:!0}),p=new BsORM(g);function Home(){var e;let[t,l]=(0,s.$G)(),n=(0,r.useRef)(),[d,h]=useKeepState({output:{type:"preview"},chartType:"line",chart:{max:10,min:0,order:"default",auto:!0,showValue:!0}}),[f,m]=(0,r.useState)(createOption("line",{A:10,B:0,C:10},null==d?void 0:d.chart)),v=(0,r.useCallback)(e=>{h(Object.assign({},mergeDeep(d,e)))},[d,h]);(0,r.useEffect)(()=>{console.log("useEffect"),g.bitable.bridge.getLanguage().then(e=>{l.changeLanguage(e.includes("zh")?"zh":"en")})},[]);let y=(0,r.useCallback)(async e=>{if(console.log(e,n),d.select=e.select,0===Object.keys((null==(e=mergeDeep(d,e))?void 0:e.select)||{}).length)return a.FN.error(t("toast-select-number-field"));let l=a.FN.info({icon:(0,i.jsx)(a.yC,{}),content:"".concat(t("toast-gening"),"..."),duration:0}),r="";if("multiToField"!==e.output.type){let t=await g.getSelection();if(console.log({select:t}),t.recordId)r=t.recordId;else{var o;(null==e?void 0:null===(o=e.output)||void 0===o?void 0:o.type)==="preview"&&(r=await (await g.getActiveTable()).getRecords({pageSize:1}).then(e=>e.records[0].recordId))}}if(console.log({recordId:r}),"multiToField"===e.output.type){let r=await g.getRecordIds();if(!r.length)return a.FN.error(t("toast-add-record"));for(let n=0;n<r.length;n++){a.FN.close(l),l=a.FN.info({icon:(0,i.jsx)(a.yC,{}),content:"".concat(t("toast-gening"),"(").concat(n+1,"/").concat(r.length,")..."),duration:0});let o=r[n],s=await gene(o);if(!s)continue;let d=p.getFieldsMap().get(e.output.field);if(await (null==d?void 0:d.getType())!==c.fS.Attachment)return a.FN.close(l),a.FN.error(t("toast-select-field"));null==d||d.setValue(o,[await fileToIOpenAttachment(g.base,base64ToFile(s,Date.now()+".png","image/png"))])}}else if("toField"===e.output.type){if(!r)return a.FN.close(l),a.FN.error(t("toast-select-record"));let i=await gene(r),n=p.getFieldsMap().get(e.output.field);if(await (null==n?void 0:n.getType())!==c.fS.Attachment)return a.FN.close(l),a.FN.error(t("toast-select-field"));null==n||n.setValue(r,[await fileToIOpenAttachment(g.base,base64ToFile(i,Date.now()+".png","image/png"))])}else{if(!r)return a.FN.close(l),a.FN.error(t("toast-select-record"));await gene(r)}async function gene(t){var l;let i=await p.getRecord(t),a=e.select.reduce((e,t)=>{let l=toDisplay(i[t]);if(l||(l=0),"number"==typeof(l=Number(l))&&l==l){var a,r;e[null===(r=p.getFieldsMap())||void 0===r?void 0:null===(a=r.get(t))||void 0===a?void 0:a.name]=l}return e},{});if(0===Object.keys(a).length)return;m(createOption(e.chartType,a,null==e?void 0:e.chart)),console.log(i,a),await new Promise(e=>setTimeout(e,1));let r=null===(l=n.current)||void 0===l?void 0:l.getDataURL();return r}a.FN.close(l),a.FN.success(t("toast-gene-success"))},[d,t]),b=(0,r.useCallback)(e=>{v(e.values)},[v]);function createOption(e,t){let l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=Object.keys(t),a=Math.max(...i.map(e=>e.length));return("asc"===l.order||"desc"===l.order)&&(i=extractAndSortNumbers(i),"desc"===l.order&&(i=i.reverse())),l.auto&&i.length&&(l.max=Math.max(...i.map(e=>t[e])),l.min=0),({get line(){var r;return{wrapStyle:{width:"".concat((null!==(r=i.length)&&void 0!==r?r:0)*100+100,"px"),height:"500px"},animation:!1,xAxis:{type:"category",data:i},yAxis:{type:"value"},series:[{data:i.map(e=>t[e]),type:"line"}]}},get bar(){var n;return{wrapStyle:{width:"".concat((null!==(n=i.length)&&void 0!==n?n:0)*100+100,"px"),height:"500px"},animation:!1,xAxis:{type:"category",data:i},yAxis:{type:"value"},series:[{data:i.map(e=>t[e]),type:"bar"}]}},get radar(){return i.map(e=>t[e]),{wrapStyle:{width:"500px",height:"500px"},animation:!1,textStyle:{fontSize:16},radar:{indicator:i.map(e=>({name:e,max:t[e]>l.max?t[e]:l.max,min:l.min,color:t[e]>l.max?"red":void 0})),axisName:{color:"#5470c6"},center:["50%","50%"],radius:a>5?"50%":a>4?"60%":"70%"},series:[{name:"Budget vs spending",type:"radar",data:[{value:i.map(e=>t[e]),areaStyle:{color:"rgba(66, 139, 212, 0.3)"},label:{show:l.showValue,position:"inside"}}]}]}}})[e]||{}}return(0,i.jsx)("main",{className:o().main,children:(0,i.jsxs)(BProvide,{orm:p,formProps:{onSubmit:y,onChange:b,labelPosition:"left",initValues:d},loadingText:t("init"),children:[(0,i.jsx)(u.Z,{text:t("field-conf"),style:{marginTop:"10px"},children:(0,i.jsx)(BSelectField,{field:"select",label:t("select-field"),placeholder:t("select-field-tip"),multiple:!0})}),(0,i.jsxs)(u.Z,{text:t("chart-conf"),style:{marginTop:"10px"},children:[(0,i.jsx)(a.l0.Select,{field:"chartType",label:t("chart-conf-type"),optionList:[{label:t("chart-conf-line"),value:"line"},{label:t("chart-conf-bar"),value:"bar"},{label:t("chart-conf-radar"),value:"radar"}],onChange:e=>{console.log(e),v({chartType:e})}}),{get bar(){return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.l0.Select,{field:"chart.order",label:t("chart-conf-order"),placeholder:t("chart-conf-"+d.chart.order),optionList:[{label:t("chart-conf-default"),value:"default"},{label:t("chart-conf-asc"),value:"asc"},{label:t("chart-conf-desc"),value:"desc"}]})})},get line(){return(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(a.l0.Select,{field:"chart.order",label:t("chart-conf-order"),placeholder:t("chart-conf-"+d.chart.order),optionList:[{label:t("chart-conf-default"),value:"default"},{label:t("chart-conf-asc"),value:"asc"},{label:t("chart-conf-desc"),value:"desc"}]})})},get radar(){var x;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.l0.Switch,{field:"chart.showValue",label:t("chart-conf-showValue"),defaultValue:d.chart.showValue,initValue:d.chart.showValue}),(0,i.jsx)(a.l0.Switch,{field:"chart.auto",label:t("chart-conf-auto"),defaultValue:d.chart.auto,initValue:d.chart.auto,onChange:e=>v({chart:{auto:e}})}),!(null===(x=d.chart)||void 0===x?void 0:x.auto)&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.l0.InputNumber,{field:"chart.max",placeholder:d.chart.max,label:t("chart-conf-max")}),(0,i.jsx)(a.l0.InputNumber,{field:"chart.min",placeholder:d.chart.min,label:t("chart-conf-min")})]})]})}}[d.chartType]||null]}),(0,i.jsxs)(u.Z,{text:t("output-conf"),style:{marginTop:"10px"},children:[(0,i.jsxs)(a.l0.Select,{field:"output.type",label:t("output-type"),children:[(0,i.jsx)(a.l0.Select.Option,{value:"preview",children:t("priview")}),(0,i.jsx)(a.l0.Select.Option,{value:"toField",children:t("gene-to-field")}),(0,i.jsx)(a.l0.Select.Option,{value:"multiToField",children:t("gene-multi-to-field")})]}),(null==d?void 0:d.output)&&(null==d?void 0:null===(e=d.output)||void 0===e?void 0:e.type)!=="preview"&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(BSelectField,{field:"output.field",filterOption:e=>(null==e?void 0:e.type)===c.fS.Attachment,label:t("output-field"),placeholder:t("output-field-tip")}),(0,i.jsx)(a.jL,{type:"danger",description:t("output-field-danger"),style:{marginBottom:"10px"}})]})]}),(0,i.jsxs)(a.T,{children:[(0,i.jsx)(a.zx,{htmlType:"submit",block:!0,type:"primary",children:t("btn-gene")}),(0,i.jsx)(a.zx,{type:"secondary",block:!0,onClick:()=>open("https://zhuanlan.zhihu.com/p/669107200"),children:t("btn-help")})]}),(0,i.jsx)("div",{style:{width:"100%",overflow:"scroll"},children:(0,i.jsx)("div",{style:f.wrapStyle,children:(0,i.jsx)(ECharts,{refInstance:n,option:f})})})]})})}function toDisplay(e){var t,l;return"object"==typeof e?null!==(l=null==e?void 0:e.text)&&void 0!==l?l:null==e?void 0:null===(t=e.map)||void 0===t?void 0:t.call(e,e=>{var t;return null!==(t=null==e?void 0:e.text)&&void 0!==t?t:null==e?void 0:e.name}).filter(e=>e).join(","):e}function extractAndSortNumbers(e){let t={零:0,一:1,二:2,三:3,四:4,五:5,六:6,七:7,八:8,九:9,十:10,百:100,千:1e3,万:1e4,亿:1e8};function chineseToNumber(e){let l=0,i=0,a=1;for(let r of e.split("")){let e=t[r];e<10?i=e:(0===i&&(i=1),e>a?(l+=i,l*=e,i=0):l+=i*e,a=e,i=0)}return l+i}function extractNumber(e){let t=e.match(/(\d+|[零一二三四五六七八九十百千万亿]+)/g);return t?t.reduce((e,t)=>e+(isNaN(Number(t))?chineseToNumber(t):Number(t)),0):0}function sortWithNumbers(e,t){let l=extractNumber(e),i=extractNumber(t);return l-i}return e.slice().sort(sortWithNumbers)}function mergeDeep(e,t){let l=Object.keys(t),i=l.length;for(let a=0;a<i;a++){let i=l[a];"object"==typeof t[i]&&"object"==typeof e[i]?mergeDeep(e[i],t[i]):e[i]=t[i]}return e}},4484:function(e){e.exports={main:"Home_main__ElU3j",h4:"Home_h4__4GCIr",code:"Home_code__ESbU9"}}}]);
//# sourceMappingURL=809.4b6bcc5989a1a1ae.js.map